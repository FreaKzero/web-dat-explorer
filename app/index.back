<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <title>Arcade Finder</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  </head>

  <body class="relative w-full min-h-screen text-white">
    <div class="fixed inset-0 bg-[url('/static/background.jpg')] bg-top bg-no-repeat bg-cover"></div>

    <div id="app" class="relative w-full">
      <script type="module">
        import { h, render } from "https://esm.sh/preact@latest";
        import { useState, useEffect, useRef } from "https://esm.sh/preact@latest/hooks";
        import htm from "https://esm.sh/htm@3.1.1";

        const html = htm.bind(h);

        const inputClass = `
          bg-black/70 text-white
          rounded-md
          px-3 py-2
          text-sm
          border border-fuchsia-700
          ring-1 ring-fuchsia-700
          focus:outline-none
          focus:ring-2 focus:ring-orange-500
          focus:border-transparent
          transition-all duration-200
        `;

        const Item = ({ description, name, manufacturer, year, cloneof, onClone }) => html`
          <li class="group relative w-80 overflow-hidden rounded-xl
                     bg-[url('/static/noimage.png')] bg-top bg-no-repeat bg-cover
                     ring-1 ring-fuchsia-700
                     hover:ring-4 hover:ring-orange-500
                     transition-all duration-300
                     hover:scale-105">
            <img src="image?name=${name}"
                 class="h-56 w-full object-contain
                        transition-all duration-1000
                        group-hover:brightness-25
                        group-hover:scale-105" />

            <div class="pointer-events-none absolute top-0 left-0 w-full
                        bg-gradient-to-b from-black/90 to-transparent
                        px-4 py-3 text-center">
              <p class="text-lg font-bold text-white
                        group-hover:text-orange-400
                        transition-colors duration-300">
                ${description}
              </p>
            </div>

            <div class="pointer-events-none absolute bottom-0 left-0 w-full
                        flex items-center justify-between
                        bg-gradient-to-t from-black/90 to-transparent
                        px-3 py-2 text-xs font-bold">
              <div class="flex items-center gap-1"><span>ðŸ“…</span><span>${year}</span></div>
              <div class="flex items-center gap-1"><span>ðŸ‘¾</span><span>${manufacturer}</span></div>
            </div>

            <div class="absolute inset-0 flex flex-col items-center justify-center gap-2
                        opacity-0 -translate-y-10
                        transition-all duration-300
                        group-hover:opacity-100
                        group-hover:translate-y-0">
              <div class="text-center text-xs">
                <p class="font-bold text-xl cursor-default">${name}</p>
                ${cloneof && html`
                  <p class="font-bold text-white hover:text-orange-400
                            transition-colors duration-300 cursor-pointer"
                     onClick=${() => onClone(cloneof)}>Clone of ${cloneof}</p>
                `}
              </div>
            </div>
          </li>
        `;

        const ComboBox = ({ label, options, value, onChange }) => {
          
  const [open, setOpen] = useState(false);
  const [query, setQuery] = useState("");
  const [highlightedIndex, setHighlightedIndex] = useState(-1);
  const inputRef = useRef(null);
  const listRef = useRef(null);

  const filtered = query
    ? options.filter(o => o.toLowerCase().includes(query.toLowerCase()))
    : options;

  const handleKeyDown = (e) => {
    if (!open) return;

    if (e.key === "ArrowDown") {
      e.preventDefault();
      setHighlightedIndex((prev) => Math.min(prev + 1, filtered.length - 1));
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      setHighlightedIndex((prev) => Math.max(prev - 1, 0));
    } else if (e.key === "Enter") {
      e.preventDefault();
      if (highlightedIndex >= 0 && highlightedIndex < filtered.length) {
        onChange(filtered[highlightedIndex]);
        setOpen(false);
      }
    } else if (e.key === "Escape") {
      e.preventDefault();
      setOpen(false);
    }
  };

  useEffect(() => {
    if (highlightedIndex >= 0 && listRef.current) {
      const el = listRef.current.children[highlightedIndex];
      if (el) el.scrollIntoView({ block: "nearest" });
    }
  }, [highlightedIndex]);

  return html`
    <div class="relative w-44 text-left">
      <label class="block text-xs font-semibold text-gray-300 mb-1">${label}</label>
      <div class="relative">
        <input
          ref=${inputRef}
          type="text"
          value=${value}
          onFocus=${() => { setQuery(""); setOpen(true); }}
          onInput=${e => { setQuery(e.target.value); setOpen(true); }}
          onBlur=${() => setTimeout(() => setOpen(false), 120)}
          onKeyDown=${handleKeyDown}
          class=${inputClass + " w-full pr-6 cursor-pointer"}
        />
        ${value && html`
          <button
            type="button"
            onMouseDown=${e => {
              e.preventDefault();
              onChange('');
              setQuery('');
              setOpen(true);
              inputRef.current.focus();
              setHighlightedIndex(-1);
            }}
            class="absolute right-1 top-1/2 -translate-y-1/2 text-white hover:text-orange-500 font-bold"
          >
            Ã—
          </button>
        `}
      </div>

      ${open && filtered.length > 0 && html`
        <ul ref=${listRef} class="
          absolute z-50 mt-1 w-full
          max-h-56 overflow-auto
          rounded-md
          bg-black/95
          ring-1 ring-fuchsia-700
        ">
          ${filtered.map((opt, i) => html`
            <li
              class="px-3 py-2 text-sm cursor-pointer transition-colors
                     ${i === highlightedIndex ? "bg-orange-500 text-black" : "hover:bg-orange-500 hover:text-black"}"
              onMouseDown=${() => { onChange(opt); setOpen(false); }}
              onMouseEnter=${() => setHighlightedIndex(i)}
            >
              ${opt}
            </li>
          `)}
        </ul>
      `}
    </div>
  `;

        };

        const App = () => {
          const [textSearch, setTextSearch] = useState("");
          const [manufacturers, setManufacturers] = useState([]);
          const [datasets, setDatasets] = useState([]);
          const [manuSearch, setManuSearch] = useState("");
          const [datasetSearch, setDatasetSearch] = useState("");
          const [list, setList] = useState([]);

          useEffect(() => {
            fetch("/dropdowns")
              .then(r => r.json())
              .then(j => { setManufacturers(j.manufacturers || []); setDatasets(j.datasets || []); });
          }, []);

          const handleOnClone = async (clone) => {
            setManuSearch("");
            setDatasetSearch("");
            setTextSearch(clone);
            const res = await fetch(`/search?q=${encodeURIComponent(clone)}`);
            setList(await res.json());
          };

          const handleFetch = async (e) => {
            e.preventDefault();
            const q = `${manuSearch} ${datasetSearch} ${textSearch}`.trim();
            if (!q) return;
            const res = await fetch(`/search?q=${encodeURIComponent(q)}`);
            setList(await res.json());
          };

          return html`
            <div class="mt-12 mb-12 text-center">
              <form onSubmit=${handleFetch} class="flex flex-wrap items-end justify-center gap-3 mb-10">
                <input type="text"
                       placeholder="Searchâ€¦"
                       value=${textSearch}
                       onInput=${e => setTextSearch(e.target.value)}
                       class=${inputClass + " w-64"} />

                <${ComboBox} label="Company" options=${manufacturers} value=${manuSearch} onChange=${v => setManuSearch(v)} />
                <${ComboBox} label="Dataset" options=${datasets} value=${datasetSearch} onChange=${v => setDatasetSearch(v)} />

                <button type="submit"
                        class="px-5 py-2 rounded-md bg-orange-500 text-black font-bold hover:bg-orange-400 active:scale-95 transition-all duration-200">
                  Search
                </button>
              </form>

              <ul class="flex flex-wrap justify-center gap-6">
                ${list.map(item => html`
                  <${Item}
                    description=${item.description}
                    name=${item.name}
                    manufacturer=${item.manufacturer}
                    year=${item.year}
                    cloneof=${item.clone_of}
                    onClone=${handleOnClone}
                  />
                `)}
              </ul>
            </div>
          `;
        };

        render(html`<${App} />`, document.getElementById("app"));
      </script>
    </div>
  </body>
</html>
