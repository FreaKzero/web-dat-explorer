<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <title>Arcade Finder</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  </head>
  <body class="relative w-full min-h-screen text-white">
    <div
      class="fixed inset-0 bg-[url('/static/background.jpg')] bg-top bg-no-repeat bg-cover"
    ></div>
    <div id="app" class="relative w-full">
      <script type="module">
        import { h, render } from "https://esm.sh/preact@latest";
        import {
          useState,
          useEffect,
          useRef,
        } from "https://esm.sh/preact@latest/hooks";
        import htm from "https://esm.sh/htm@3.1.1";

        const html = htm.bind(h);

        const inputClass = `
          bg-black/70 text-white
          rounded-md
          px-3 py-2
          text-sm
          border border-fuchsia-700
          ring-1 ring-fuchsia-700
          focus:outline-none
          focus:ring-2 focus:ring-orange-500
          focus:border-transparent
          transition-all duration-200
        `;

        const Item = ({
          description,
          name,
          manufacturer,
          year,
          cloneof,
          onClickSearch,
        }) => {
          return html`
            <li
              class="group bg-[url('/static/noimage.png')] bg-top bg-no-repeat bg-cover relative w-80 overflow-hidden rounded-xl ring-1 ring-fuchsia-700 hover:ring-5 hover:ring-orange-500 transition-all duration-300 transform transition-all duration-300 hover:scale-105"
            >
              <img
                src="image?name=${name}"
                class="h-56 w-full object-contain transition-all duration-1000 group-hover:brightness-25 group-hover:scale-105"
              />

              <div
                class="pointer-events-none absolute top-0 left-0 w-full
                       bg-gradient-to-b from-black/90 to-transparent
                       px-4 py-3 text-center"
              >
                <p
                  class="text-lg font-bold text-white group-hover:text-orange-400 transition-colors duration-300 cursor-default"
                >
                  ${description}
                </p>
              </div>

              <div
                class="pointer-events-none absolute bottom-0 left-0 w-full
                       flex items-center justify-between
                       bg-gradient-to-t from-black/90 to-transparent
                       px-3 py-2 text-xs text-white"
              >
                <div class="flex items-center gap-1 font-bold cursor-default">
                  <span>ðŸ“…</span>
                  <span>${year}</span>
                </div>

                <div class="flex items-center gap-1 font-extrabold">
                  <span>ðŸ‘¾ ${manufacturer}</span>
                </div>
              </div>

              <div
                class="absolute inset-0 flex flex-col items-center justify-center gap-2
         opacity-0 -translate-y-10 mt-15
         transition-all duration-300
         group-hover:opacity-100 group-hover:translate-y-0"
              >
                <div class="text-center text-xs text-white">
                  <p class="font-bold text-xl cursor-default">${name}</p>
                  <p
                    class="font-bold hover:text-orange-400 text-white transition-all duration-500 cursor-pointer"
                    onClick=${() => onClickSearch(cloneof)}
                  >
                    ${cloneof && `Clone of ${cloneof}`}
                  </p>
                </div>

                <div class="flex gap-3 mt-1">
                  <a
                    target="_blank"
                    href="/redirect?name=${name}&type=dl"
                    class="hover:stroke-orange-400 stroke-white transition-all duration-500"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="40px"
                      height="40px"
                      viewBox="0 0 24 24"
                      fill="none"
                    >
                      <path
                        d="M12 7L12 14M12 14L15 11M12 14L9 11"
                        stroke-width="1.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                      <path
                        d="M16 17H12H8"
                        stroke-width="1.5"
                        stroke-linecap="round"
                      />
                      <path
                        d="M22 12C22 16.714 22 19.0711 20.5355 20.5355C19.0711 22 16.714 22 12 22C7.28595 22 4.92893 22 3.46447 20.5355C2 19.0711 2 16.714 2 12C2 7.28595 2 4.92893 3.46447 3.46447C4.92893 2 7.28595 2 12 2C16.714 2 19.0711 2 20.5355 3.46447C21.5093 4.43821 21.8356 5.80655 21.9449 8"
                        stroke-width="1.5"
                        stroke-linecap="round"
                      />
                    </svg>
                  </a>

                  <a
                    target="_blank"
                    href="/redirect?name=${name}&type=wiki"
                    class="hover:stroke-orange-400 stroke-white transition-all duration-500"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="40px"
                      height="40px"
                      viewBox="0 0 24 24"
                      fill="none"
                    >
                      <path
                        d="M10.125 8.875C10.125 7.83947 10.9645 7 12 7C13.0355 7 13.875 7.83947 13.875 8.875C13.875 9.56245 13.505 10.1635 12.9534 10.4899C12.478 10.7711 12 11.1977 12 11.75V13"
                        stroke-width="1.5"
                        stroke-linecap="round"
                      />
                      <circle cx="12" cy="16" r="1" fill="#1C274C" />
                      <path
                        d="M22 12C22 16.714 22 19.0711 20.5355 20.5355C19.0711 22 16.714 22 12 22C7.28595 22 4.92893 22 3.46447 20.5355C2 19.0711 2 16.714 2 12C2 7.28595 2 4.92893 3.46447 3.46447C4.92893 2 7.28595 2 12 2C16.714 2 19.0711 2 20.5355 3.46447C21.5093 4.43821 21.8356 5.80655 21.9449 8"
                        stroke-width="1.5"
                        stroke-linecap="round"
                      />
                    </svg>
                  </a>

                  <a
                    target="_blank"
                    href="/redirect?name=${name}&type=wiki"
                    class="hover:stroke-orange-400 stroke-white transition-all duration-500"
                  >
                    <svg
                      width="40px"
                      height="40px"
                      viewBox="0 0 800 800"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M733.333 400C733.333 557.133 733.333 635.703 684.517 684.517C635.703 733.333 557.133 733.333 400 733.333C242.865 733.333 164.298 733.333 115.482 684.517C66.6667 635.703 66.6667 557.133 66.6667 400C66.6667 242.865 66.6667 164.298 115.482 115.482C164.298 66.6667 242.865 66.6667 400 66.6667C557.133 66.6667 635.703 66.6667 684.517 115.482C716.977 147.94 727.853 193.552 731.497 266.667"
                        stroke-width="50"
                        stroke-linecap="round"
                      />
                      <path
                        d="M290.924 306.628C245.911 316.813 223.405 321.905 218.051 339.124C212.696 356.342 228.039 374.285 258.726 410.167L266.665 419.451C275.385 429.648 279.745 434.746 281.706 441.054C283.668 447.362 283.009 454.164 281.69 467.77L280.49 480.156C275.851 528.032 273.531 551.971 287.549 562.612C301.568 573.254 322.64 563.551 364.785 544.147L375.688 539.126C387.664 533.612 393.652 530.854 400 530.854C406.348 530.854 412.336 533.612 424.311 539.126L435.214 544.147C477.359 563.551 498.432 573.254 512.451 562.612C526.469 551.971 524.149 528.032 519.51 480.156M541.274 410.167C571.961 374.285 587.304 356.342 581.949 339.124C576.595 321.905 554.087 316.813 509.077 306.628L497.431 303.993C484.639 301.099 478.245 299.652 473.11 295.754C467.973 291.856 464.681 285.947 458.093 274.131L452.096 263.373C428.917 221.791 417.328 201 400 201C382.672 201 371.082 221.791 347.903 263.373"
                        stroke-width="45"
                        stroke-linecap="round"
                      />
                    </svg>
                  </a>
                </div>
              </div>
            </li>
          `;
        };

        const TextInput = ({
          label,
          value,
          onInput,
          placeholder,
          type = "text",
          className = "",
        }) => {
          const [inputValue, setInputValue] = useState(value || "");
          const inputRef = useRef(null);

          useEffect(() => {
            setInputValue(value || "");
          }, [value]);

          const handleClear = (e) => {
            e.preventDefault();
            setInputValue("");
            if (onInput) onInput({ target: { value: "" } }); // wie echtes input event
            inputRef.current.focus();
          };

          return html`
            <div class="relative w-64 text-left">
              ${label &&
              html`<label class="block text-xs font-semibold text-gray-300 mb-1"
                >${label}</label
              >`}
              <div class="relative">
                <input
                  ref=${inputRef}
                  type=${type}
                  value=${inputValue}
                  placeholder=${placeholder || ""}
                  onInput=${(e) => {
                    setInputValue(e.target.value);
                    if (onInput) onInput(e);
                  }}
                  class=${inputClass + " w-full pr-6 " + className}
                />
                ${inputValue &&
                html`
                  <button
                    type="button"
                    onMouseDown=${handleClear}
                    class="absolute right-3 top-[6px] text-white hover:text-orange-500 font-bold transition-all duration-300 cursor-pointer"
                  >
                    Ã—
                  </button>
                `}
              </div>
            </div>
          `;
        };

        const ComboBox = ({ label, options, value, onChange }) => {
          const [open, setOpen] = useState(false);
          const [inputValue, setInputValue] = useState("");
          const [highlightedIndex, setHighlightedIndex] = useState(-1);
          const inputRef = useRef(null);
          const listRef = useRef(null);

          const filtered = inputValue
            ? options.filter((o) =>
                o.toLowerCase().includes(inputValue.toLowerCase())
              )
            : options;

          const handleKeyDown = (e) => {
            if (!open) return;

            if (e.key === "ArrowDown") {
              e.preventDefault();
              setHighlightedIndex((prev) =>
                Math.min(prev + 1, filtered.length - 1)
              );
            } else if (e.key === "ArrowUp") {
              e.preventDefault();
              setHighlightedIndex((prev) => Math.max(prev - 1, 0));
            } else if (e.key === "Enter") {
              e.preventDefault();
              if (highlightedIndex >= 0 && highlightedIndex < filtered.length) {
                onChange(filtered[highlightedIndex]);
                setInputValue(filtered[highlightedIndex]);
                setOpen(false);
              }
            } else if (e.key === "Escape") {
              e.preventDefault();
              setOpen(false);
            } else if (e.key === "Backspace") {
              e.preventDefault();
              onChange("");
              setInputValue("");
              setOpen(true);
              setHighlightedIndex(-1);
              inputRef.current.focus();
            }
          };

          useEffect(() => {
            if (highlightedIndex >= 0 && listRef.current) {
              const el = listRef.current.children[highlightedIndex];
              if (el) el.scrollIntoView({ block: "nearest" });
            }
          }, [highlightedIndex]);

          useEffect(() => {
            setInputValue(value || "");
          }, [value]);

          return html`
            <div class="relative w-60 text-left">
              <label class="block text-xs font-semibold text-gray-300 mb-1"
                >${label}</label
              >
              <div class="relative">
                <input
                  ref=${inputRef}
                  type="text"
                  value=${inputValue}
                  onFocus=${() => {
                    setOpen(true);
                    setHighlightedIndex(-1);
                  }}
                  onInput=${(e) => {
                    setInputValue(e.target.value);
                    setOpen(true);
                    setHighlightedIndex(-1);
                  }}
                  onBlur=${() => setTimeout(() => setOpen(false), 120)}
                  onKeyDown=${handleKeyDown}
                  class=${inputClass + " w-full pr-6 cursor-pointer"}
                />
                ${value &&
                html`
                  <button
                    type="button"
                    onMouseDown=${(e) => {
                      e.preventDefault();
                      onChange("");
                      setInputValue("");
                      setOpen(true);
                      setHighlightedIndex(-1);
                      inputRef.current.focus();
                    }}
                    class="absolute right-3 font-bold cursor-pointer top-[6px] text-white hover:text-orange-500 font-bold transition-all duration-300"
                  >
                    Ã—
                  </button>
                `}
              </div>

              ${open &&
              filtered.length > 0 &&
              html`
                <ul
                  ref=${listRef}
                  class="
          absolute z-50 mt-1 w-full
          max-h-70 overflow-auto
          rounded-md
          bg-black/50
          ring-1 ring-fuchsia-700
          backdrop-blur-md
        "
                >
                  ${filtered.map(
                    (opt, i) => html`
                      <li
                        class="px-3 py-2 text-sm cursor-pointer transition-colors
                     ${i === highlightedIndex
                          ? "bg-orange-500 text-black"
                          : "hover:bg-orange-500 hover:text-black"}"
                        onMouseDown=${() => {
                          onChange(opt);
                          setInputValue(opt);
                          setOpen(false);
                        }}
                        onMouseEnter=${() => setHighlightedIndex(i)}
                      >
                        ${opt}
                      </li>
                    `
                  )}
                </ul>
              `}
            </div>
          `;
        };

        const App = () => {
          const [textSearch, setTextSearch] = useState("");
          const [manufacturers, setManufacturers] = useState([]);
          const [list, setList] = useState([]);
          const [manuSearch, setManuSearch] = useState("");
          const [datasetSearch, setDatasetSearch] = useState("");
          const [datasets, setDatasets] = useState([]);

          useEffect(() => {
            const fetchData = async () => {
              const data = await fetch("/dropdowns");
              const json = await data.json();
              setManufacturers(json.manufacturers);
              setDatasets(json.datasets);
            };
            fetchData("/companies").catch(console.error);
          }, []);

          const handleClickSearch = async (cl) => {
            setManuSearch("");
            setDatasetSearch("");
            setTextSearch(cl);
            const x = `q=${encodeURI(cl)}`;
            const res = await fetch(`/search?${x}`);
            const list = await res.json();
            setList(list);
          };

          const handleFetch = async (e) => {
            e.preventDefault();
            const search =
              `${manuSearch} ${datasetSearch} ${textSearch}`.trim();
            if (search.length > 0) {
              const x = `q=${encodeURI(search)}`;
              const res = await fetch(`/search?${x}`);
              const list = await res.json();
              setList(list);
            }
          };

          return html`
            <div class="font-sans text-center">
              <div
                class="sticky top-0 z-50 w-full bg-black/80 px-4 py-3 flex justify-center shadow-md pb-8"
              >
                <form
                  onSubmit=${handleFetch}
                  class="flex flex-wrap items-end justify-center gap-3 w-full max-w-4xl"
                >
                  <${TextInput}
                  label="Fulltext"
                    value=${textSearch}
                    onInput=${(e) => setTextSearch(e.target.value)}
                  />

                  <${ComboBox}
                    label="Company"
                    options=${manufacturers}
                    value=${manuSearch}
                    onChange=${(v) => setManuSearch(v)}
                  />
                  <${ComboBox}
                    label="Dataset"
                    options=${datasets}
                    value=${datasetSearch}
                    onChange=${(v) => setDatasetSearch(v)}
                  />

                  <button
                    type="submit"
                    class="px-3 py-1 bg-orange-500 rounded-md"
                  >
                    Search
                  </button>
                </form>
              </div>

              <div class="mx-auto w-3/4 mt-10">
                <ul class="flex flex-wrap justify-center gap-6">
                  ${list.map(
                    (item) => html`
                      <${Item}
                        description=${item.description}
                        name=${item.name}
                        manufacturer=${item.manufacturer}
                        year=${item.year}
                        cloneof=${item.clone_of}
                        onClickSearch=${handleClickSearch}
                      />
                    `
                  )}
                </ul>
              </div>
            </div>
          `;
        };

        render(html`<${App} />`, document.getElementById("app"));
      </script>
    </div>
  </body>
</html>
